<!-- Copyright 2021 Carnegie Mellon University. All Rights Reserved. -->
<!-- Released under a MIT (SEI)-style license. See LICENSE.md in the project root for license information. -->
<ng-container *ngIf="teamEvents$ | async"></ng-container>

<ng-container *ngIf="ctx$ | async as ctx">
  <div class="card mb-4">
    <app-spinner *ngIf="isChangingSessionStatus else cardContent">
      {{statusText}}
    </app-spinner>

    <ng-template #cardContent>
      <div *ngIf="ctx.player" class="card-body">
        <alert *ngIf="!ctx.player.session.isDuring" [type]="ctx.game.session.countdown | countdownAlertType">
          <p *ngIf="ctx.game.session.isBefore">The game window opens in <strong>{{ctx.game.session.countdown |
              countdown}}</strong></p>
          <p *ngIf="ctx.game.session.isDuring">The game window closes in <strong>{{ctx.game.session.countdown |
              countdown}}</strong></p>
          <p *ngIf="ctx.game.session.isAfter">The game window is closed.</p>
        </alert>

        <div class="card-title lead">
          <ng-container *ngIf="!ctx.player.session.isBefore">
            <div class="d-flex text-info card-text">
              <alert [type]="ctx.player.session.countdown | countdownAlertType">
                <p *ngIf="ctx.player.session.isDuring">Time Remaining: <strong>{{ctx.player.session.countdown |
                    countdown}}</strong></p>
                <p *ngIf="ctx.player.session.isAfter">Session ended</p>
              </alert>
              <div class="spacer"></div>
              <app-confirm-button *ngIf="ctx.game.allowReset" class="mx-2" btnClass="btn btn-sm pop-warning"
                [disabled]="isChangingSessionStatus" (confirm)="reset(ctx.player)">
                <fa-icon [icon]="faTrash"></fa-icon>
                <span>Reset Session</span>
              </app-confirm-button>
            </div>
          </ng-container>
        </div>

        <!--TEAM LEADER / LIST-->
        <div class="team-leader">
          <img [src]="ctx.player.sponsorLogo" class="mr-3 team-leader-sponsor-logo">
          <div class="mr-2 team-leader-name">
            <p class="team-header">Team</p>
            <p class="team-leader-name-text">{{ctx.player.approvedName}}</p>
            <small *ngIf="!!ctx.player.pendingName" class="text-muted">({{ctx.player.pendingName}})</small>
          </div>
        </div>

        <hr class="team-leader-divider" />

        <ng-container *ngIf="ctx.game.allowTeam">
          <app-player-presence [id]="ctx.player.teamId"></app-player-presence>
        </ng-container>

        <!--SCOREBOARD-->
        <table class="table mt-2 text-center">
          <tbody>
            <tr>
              <th>Rank</th>
              <th>Score</th>
              <th>Cumulative Time</th>
              <th>Completes</th>
              <th>Partials</th>
            </tr>
            <tr>
              <td>{{ctx.player.rank}}</td>
              <td>{{ctx.player.score}}</td>
              <td>{{ctx.player.time | clock}}</td>
              <td>{{ctx.player.correctCount}}</td>
              <td>{{ctx.player.partialCount}}</td>
            </tr>
          </tbody>
        </table>

        <app-error-div [errors]="errors"></app-error-div>

        <ng-container *ngIf="ctx.player && ctx.player.session.isBefore && !ctx.player.session.isDuring">
          <div class="card-text my-4" *ngIf="doublechecking">
            <alert type="danger">
              <ul>
                <li>
                  Once the session starts, you have <strong>{{ctx.game.sessionMinutes}} minutes</strong> to play.
                  {{ !ctx.game.allowReset ? "You won't be able to reset the session after it's begun." : "" }}
                </li>
                <li [hidden]="ctx.game.maxTeamSize < 2">
                  You can't add or remove team members after your session has started, so be sure you're partied
                  up.
                </li>
                <li [hidden]="ctx.game.maxTeamSize < 2">
                  Starting the session starts it for your whole team. Be sure your teammates are ready!
                </li>
              </ul>
            </alert>

            <div class="text-center">
              <app-confirm-button btnClass="btn btn-lg btn-warning" (confirm)="start(ctx.player)"
                [disabled]="this.isChangingSessionStatus" (cancel)="doublechecking=false">
                <fa-icon [icon]="faBolt"></fa-icon>
                <span>Yes, start {{ctx.game.name}}</span>
              </app-confirm-button>
            </div>
          </div>

          <div class="card-text" *ngIf="!doublechecking && !ctx.player.session.isDuring">
            <alert type="warning">
              Once the session starts, you have <strong>{{ctx.game.sessionMinutes}} minutes</strong> to play.
              {{ !ctx.game.allowReset ? "You won't be able to reset the session after it's begun." : "" }}
              <div [hidden]="ctx.game.maxTeamSize < 2">
                You can't add or remove team members after your session has started, so be sure you're partied
                up. Starting the session starts it for your whole team. Be sure your teammates are ready!
              </div>
            </alert>

            <div class="mb-2">
              <label class="mb-0">Session Forecast</label><br />
              <small>Shows when sessions become available. (Green means available.)</small>
              <div class="text-center forecast">
                <app-session-forecast [game]="ctx.game"></app-session-forecast>
              </div>
            </div>
          </div>
        </ng-container>

        <div *ngIf="ctx.player && ctx.player.session.isBefore && !ctx.player.session.isDuring && !doublechecking"
          class="text-center">
          <app-confirm-button btnClass="btn btn-lg btn-primary" (confirm)="doublechecking=true"
            [disabled]="isChangingSessionStatus">
            <fa-icon [icon]="faBolt"></fa-icon>
            <span>Start Session</span>
          </app-confirm-button>
        </div>

        <ng-container *ngIf="ctx.user.isRegistrar && !ctx.player.session.isDuring">
          <div class="text-center my-4">
            <app-confirm-button btnClass="btn btn-lg btn-primary" (confirm)="start(ctx.player)"
              [disabled]="isChangingSessionStatus">
              <fa-icon [icon]="faBolt"></fa-icon>
              <span>Admin Start</span>
            </app-confirm-button>
          </div>
        </ng-container>

        <div *ngIf="!ctx.player.session.isBefore" class="text-center mb-4">
          <a *ngIf="ctx.game.mode != 'unity'" class="btn btn-primary btn-lg"
            [routerLink]="['../board', ctx.player.id]">Continue to Gameboard</a>
          <a *ngIf="ctx.game.mode == 'unity'" class="btn btn-primary bgn-lg"
            [routerLink]="['../unity-board', ctx.player.gameId, ctx.player.id, ctx.player.teamId, ctx.player.sessionEnd.toDateString()]">
            Continue to Cubespace
          </a>
        </div>

        <div class="col">
          <img [src]="ctx.game.mapUrl" alt="game map background" class="img-fluid">
        </div>
      </div>
    </ng-template>
  </div>
</ng-container>